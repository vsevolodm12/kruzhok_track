<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö—Ä—É–∂–æ–∫ –°—Ç–∞–Ω–∫–µ–≤–∏—á–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link href="https://fonts.googleapis.com/css2?family=Neucha&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body, #root { height: 100%; min-height: 100dvh; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
      overscroll-behavior: none;
      margin: 0;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 0.5rem); }
    }
  </style>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            ink:    '#2D2D2D',
            muted:  '#6B6B6B',
            faint:  '#ADADAD',
            line:   '#EBEBEB',
            surface:'#F7F7F7',
            accent: '#6366F1',
          },
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const { useState, useMemo, useRef, useEffect } = React;
    const { LineChart, Line, ResponsiveContainer, BarChart, Bar, XAxis, Tooltip, Cell, CartesianGrid } = Recharts;

    // ‚îÄ‚îÄ‚îÄ API helper (same origin ‚Äî Django serves this file) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const api = (path, opts = {}) => fetch(path, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
      ...opts,
    });

    // ‚îÄ‚îÄ‚îÄ Icons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Ic = ({ size = 20, stroke = 1.75, children, ...p }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth={stroke} strokeLinecap="round" strokeLinejoin="round" {...p}>
        {children}
      </svg>
    );
    const IcHome      = p => <Ic {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Ic>;
    const IcBook      = p => <Ic {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Ic>;
    const IcChart     = p => <Ic {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></Ic>;
    const IcMoon      = p => <Ic {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Ic>;
    const IcSun       = p => <Ic {...p}><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></Ic>;
    const IcX         = p => <Ic {...p}><path d="M18 6 6 18M6 6l12 12"/></Ic>;
    const IcChevDown  = p => <Ic {...p}><path d="m6 9 6 6 6-6"/></Ic>;
    const IcPhone     = p => <Ic {...p}><rect width="14" height="20" x="5" y="2" rx="2"/><path d="M12 18h.01"/></Ic>;
    const IcMonitor   = p => <Ic {...p}><rect width="20" height="14" x="2" y="3" rx="2"/><path d="M8 21h8M12 17v4"/></Ic>;
    const IcArrowUp   = p => <Ic {...p}><path d="m5 12 7-7 7 7M12 19V5"/></Ic>;
    const IcArrowDown = p => <Ic {...p}><path d="M12 5v14m7-7-7 7-7-7"/></Ic>;
    const IcMinus     = p => <Ic {...p}><path d="M5 12h14"/></Ic>;
    const IcCalendar  = p => <Ic {...p}><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></Ic>;
    const IcChevLeft  = p => <Ic {...p}><path d="m15 18-6-6 6-6"/></Ic>;
    const IcPencil    = p => <Ic {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></Ic>;
    const IcVideo     = p => <Ic {...p}><path d="m22 8-6 4 6 4V8z"/><rect width="14" height="12" x="2" y="6" rx="2"/></Ic>;

    // ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Page = { HOME: 'home', SCHEDULE: 'schedule', DEADLINES: 'deadlines', STATS: 'stats', HISTORY: 'history' };
    const T    = { HW: 'HW', MOCK: 'MOCK', ESSAY: 'ESSAY', PROJECT: 'PROJECT' };
    const T_LABEL      = { [T.HW]: '–î–æ–º–∞—à–∫–∞',          [T.MOCK]: '–ü—Ä–æ–±–Ω–∏–∫',  [T.ESSAY]: '–≠—Å—Å–µ',  [T.PROJECT]: '–ü—Ä–æ–µ–∫—Ç' };
    const T_LABEL_FULL = { [T.HW]: '–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ', [T.MOCK]: '–ü—Ä–æ–±–Ω–∏–∫',  [T.ESSAY]: '–≠—Å—Å–µ',  [T.PROJECT]: '–ü—Ä–æ–µ–∫—Ç' };
    const T_COLOR      = { [T.HW]: '#6366F1', [T.MOCK]: '#0EA5E9', [T.ESSAY]: '#F59E0B', [T.PROJECT]: '#8B5CF6' };
    const T_ORDER      = [T.HW, T.MOCK, T.ESSAY, T.PROJECT];

    // ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ru = (d, opts) => new Date(d).toLocaleDateString('ru-RU', opts);
    const fmt = {
      day:       d => ru(d, { day:'numeric', month:'long' }),
      monthShort:d => ru(d, { month:'short' }).replace('.','').toUpperCase(),
      time:      d => new Date(d).toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' }),
      monthYear: d => ru(d, { month:'long', year:'numeric' }),
      fullDate:  d => ru(d, { day:'numeric', month:'long', year:'numeric' }),
      dateTime:  d => `${ru(d,{weekday:'short',day:'numeric',month:'long'})} ¬∑ ${new Date(d).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}`,
    };

    // ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Card = ({ children, className='', onClick, noPad }) => (
      <div
        onClick={onClick}
        className={`bg-white dark:bg-[#1C1C1C] rounded-2xl mx-4
          ${noPad ? '' : 'p-5'}
          ${onClick ? 'cursor-pointer active:opacity-75 transition-opacity' : ''}
          ${className}`}
      >
        {children}
      </div>
    );

    // ‚îÄ‚îÄ‚îÄ Pill Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PillTabs = ({ tabs, active, onChange, className='' }) => (
      <div className={`flex items-center gap-2 overflow-x-auto no-scrollbar ${className}`}>
        {tabs.map(tab => (
          <button
            key={tab.value}
            onClick={() => onChange(tab.value)}
            className={`shrink-0 px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200
              ${active === tab.value
                ? 'bg-ink text-white dark:bg-[#F0F0F0] dark:text-ink'
                : 'bg-[#EFEFEF] dark:bg-[#252525] text-muted dark:text-[#888]'}`}
          >
            {tab.label}
          </button>
        ))}
      </div>
    );

    // ‚îÄ‚îÄ‚îÄ Section Label ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SectionLabel = ({ children }) => (
      <p className="text-[11px] font-medium text-[#8E8E93] dark:text-[#636366] uppercase tracking-[0.05em]">{children}</p>
    );

    // ‚îÄ‚îÄ‚îÄ Zoom Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ZoomModal = ({ course, onClose }) => (
      <div className="fixed inset-0 z-[100] flex items-end justify-center">
        <div className="absolute inset-0 bg-black/40 dark:bg-black/70" onClick={onClose}/>
        <div className="relative w-full max-w-[390px] bg-white dark:bg-[#1C1C1C] rounded-t-3xl shadow-2xl p-6 pb-10">
          <div className="w-10 h-1 bg-line dark:bg-[#333] rounded-full mx-auto mb-5"/>
          <button onClick={onClose}
            className="absolute top-4 right-5 w-8 h-8 rounded-full bg-surface dark:bg-[#252525] flex items-center justify-center text-muted dark:text-[#888]">
            <IcX size={15}/>
          </button>
          <SectionLabel>{course.name}</SectionLabel>
          <h3 className="text-xl font-semibold text-ink dark:text-[#DEDEDE] mt-1 mb-5">Zoom-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</h3>
          <a href={course.zoom_url} target="_blank" rel="noreferrer"
            className="flex items-center justify-center gap-2 w-full py-3.5 rounded-2xl font-semibold text-sm text-white active:opacity-80 transition-opacity"
            style={{background:'#2D8CFF'}}>
            <IcVideo size={16}/>
            –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Zoom
          </a>
          {course.zoom_passcode && (
            <p className="text-center text-sm text-muted dark:text-[#888] mt-4">
              –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: <span className="font-semibold text-ink dark:text-[#DEDEDE]">{course.zoom_passcode}</span>
            </p>
          )}
        </div>
      </div>
    );

    // ‚îÄ‚îÄ‚îÄ Task Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const TaskModal = ({ task, courseName, onClose }) => {
      if (!task) return null;
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/30 dark:bg-black/60" onClick={onClose}/>
          <div className="relative w-full max-w-sm bg-white dark:bg-[#1C1C1C] rounded-3xl shadow-2xl p-7">
            <button onClick={onClose}
              className="absolute top-5 right-5 w-8 h-8 rounded-full bg-surface dark:bg-[#252525] flex items-center justify-center text-muted dark:text-[#888] hover:bg-line dark:hover:bg-[#333] transition-colors">
              <IcX size={15}/>
            </button>
            <SectionLabel>{T_LABEL_FULL[task.type]}</SectionLabel>
            <h3 className="text-xl font-semibold text-ink dark:text-[#DEDEDE] mt-1 mb-1 leading-snug pr-8">{task.name}</h3>
            <p className="text-sm text-faint dark:text-[#555] mb-6 pb-5 border-b border-line dark:border-[#2A2A2A]">{courseName}</p>
            <div className="flex justify-between items-end">
              <div>
                <SectionLabel>–û—Ü–µ–Ω–∫–∞</SectionLabel>
                <div className="flex items-baseline gap-1 mt-1">
                  <span className="text-5xl font-semibold text-ink dark:text-[#DEDEDE]">{task.score !== null && task.score !== undefined ? task.score : '‚Äî'}</span>
                  <span className="text-xl text-faint dark:text-[#444]">/{task.maxScore}</span>
                </div>
              </div>
              <div className="text-right">
                <SectionLabel>–î–∞—Ç–∞</SectionLabel>
                <p className="text-base font-semibold text-ink dark:text-[#DEDEDE] mt-1">{task.date ? fmt.day(task.date) : '‚Äî'}</p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Flame Icon (SVG, no emoji) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FlameIcon = ({ size = 14, color = '#F97316' }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={color}>
        <path d="M17.66 11.2c-.23-.3-.51-.56-.77-.82-.67-.6-1.43-1.03-2.07-1.66C13.33 7.26 13 4.85 13.95 3c-.95.23-1.78.75-2.49 1.32C8.87 6.4 7.85 10.07 9.07 13.22c.04.1.08.2.08.33 0 .22-.15.42-.35.5-.23.1-.47.04-.66-.12a.6.6 0 0 1-.15-.17C6.87 12.33 6.69 10.28 7.45 8.64 5.78 10 4.87 12.3 5 14.47c.06.5.12 1 .29 1.5.14.6.41 1.2.71 1.73C7.08 19.43 8.95 20.67 10.96 20.92c2.14.27 4.43-.12 6.07-1.6 1.83-1.66 2.47-4.32 1.53-6.6l-.13-.26c-.21-.46-.77-1.26-.77-1.26z"/>
      </svg>
    );

    // ‚îÄ‚îÄ‚îÄ Home Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Home = ({ course, tasks, events, deadlines, streak, onSchedule, onDeadlines }) => {
      const [selectedTask, setSelectedTask] = useState(null);
      const [showZoom, setShowZoom] = useState(false);
      const courseTasks = tasks.filter(t => t.courseId === course.id);
      const tasksWithScore = courseTasks.filter(t => t.score !== null && t.score !== undefined);
      const avg = tasksWithScore.length
        ? Math.round(tasksWithScore.reduce((s,t) => s + t.score/t.maxScore, 0) / tasksWithScore.length * 100)
        : 0;

      const today = new Date(); today.setHours(0,0,0,0);
      const weekEnd = new Date(today); weekEnd.setDate(weekEnd.getDate()+7);
      const pending = deadlines.filter(d =>
        d.courseId === course.id && !d.submitted
        && new Date(d.dueDate) >= today && new Date(d.dueDate) <= weekEnd
      );

      const sortedEvents = [...events].sort((a,b) => new Date(a.startsAt)-new Date(b.startsAt));
      const now = new Date();
      const upcoming = sortedEvents.filter(e => new Date(e.startsAt) >= now).slice(0, 4);

      const getDaysLeft = dueDate => {
        const due = new Date(dueDate); due.setHours(0,0,0,0);
        return Math.round((due - today) / 86400000);
      };

      return (
        <div className="space-y-4">
          {/* –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å */}
          <Card>
            <SectionLabel>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</SectionLabel>
            <div className="flex justify-between items-start mt-4">
              <div className="flex flex-col items-center">
                <span className="text-4xl font-semibold text-ink dark:text-[#DEDEDE]">{courseTasks.length}</span>
                <span className="text-xs text-faint dark:text-[#555] mt-1 uppercase tracking-wider">–°–¥–∞–Ω–æ</span>
              </div>
              <div className="flex flex-col items-center">
                <span className="text-4xl font-semibold text-ink dark:text-[#DEDEDE]">{avg}%</span>
                <span className="text-xs text-faint dark:text-[#555] mt-1 uppercase tracking-wider">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</span>
              </div>
              <div className="flex flex-col items-center">
                <span className="text-4xl font-semibold text-ink dark:text-[#DEDEDE]">{streak}</span>
                <div className="flex items-center gap-1 mt-1">
                  <FlameIcon size={11}/>
                  <span className="text-xs text-faint dark:text-[#555] uppercase tracking-wider">–°—Ç—Ä–∏–∫</span>
                </div>
              </div>
            </div>
          </Card>

          {/* –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ */}
          <Card noPad>
            <div className="flex items-center justify-between px-5 pt-5 pb-4">
              <SectionLabel>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</SectionLabel>
              <div className="flex items-center gap-3">
                {course.zoom_url && (
                  <button onClick={() => setShowZoom(true)}
                    className="flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold text-white active:opacity-80 transition-opacity"
                    style={{background:'#2D8CFF'}}>
                    <IcVideo size={11}/>
                    Zoom
                  </button>
                )}
                <button onClick={onSchedule}
                  className="text-xs font-medium text-muted dark:text-[#888] hover:opacity-60 transition-opacity">
                  –°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ
                </button>
              </div>
            </div>
            {upcoming.length === 0 ? (
              <p className="text-sm text-faint dark:text-[#555] px-5 pb-5">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</p>
            ) : (
              <div className="px-5 pb-3">
                {upcoming.map((item, idx) => {
                  const start = new Date(item.startsAt);
                  const startDay = new Date(start); startDay.setHours(0,0,0,0);
                  const diff = Math.round((startDay - today) / 86400000);
                  const isToday = diff === 0;
                  return (
                    <div key={item.id}
                      className={`grid grid-cols-[44px_1fr] gap-3 py-3 items-center
                        ${idx < upcoming.length-1 ? 'border-b border-[#F2F2F2] dark:border-[#242424]' : ''}
                        ${isToday ? 'rounded-xl -mx-2 px-2 bg-[#EEF2FF] dark:bg-[#1A1A2E]' : ''}`}>
                      <div className="text-center">
                        <p className={`text-lg font-semibold leading-none ${isToday ? 'text-accent' : 'text-ink dark:text-[#DEDEDE]'}`}>
                          {start.getDate()}
                        </p>
                        <p className="text-[9px] font-semibold uppercase tracking-wide text-faint dark:text-[#555] mt-0.5">
                          {fmt.monthShort(item.startsAt)}
                        </p>
                      </div>
                      <div>
                        <p className="text-sm font-semibold leading-snug text-ink dark:text-[#DEDEDE]">
                          {item.topic}
                        </p>
                        <p className={`text-xs mt-0.5 ${isToday ? 'text-accent' : 'text-faint dark:text-[#555]'}`}>
                          {isToday ? '–°–µ–≥–æ–¥–Ω—è ¬∑ ' : ''}–∑–∞–Ω—è—Ç–∏–µ
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </Card>

          {/* –î–µ–¥–ª–∞–π–Ω—ã */}
          <Card noPad>
            <div className="flex items-center justify-between px-5 pt-5 pb-4">
              <SectionLabel>–î–µ–¥–ª–∞–π–Ω—ã ¬∑ 7 –¥–Ω–µ–π</SectionLabel>
              <button onClick={onDeadlines} className="text-xs font-medium text-muted dark:text-[#888] hover:opacity-60 transition-opacity">–í—Å–µ –¥–µ–¥–ª–∞–π–Ω—ã</button>
            </div>
            {pending.length === 0 ? (
              <p className="text-sm text-faint dark:text-[#555] px-5 pb-5">–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤</p>
            ) : (
              <div className="space-y-3 px-5 pb-5">
                {pending.map(item => {
                  const days = getDaysLeft(item.dueDate);
                  const isUrgent = days <= 1;
                  const barCls = isUrgent ? 'bg-[#1A1A1A] dark:bg-[#E0E0E0]' : 'bg-[#D0D0D0] dark:bg-[#3A3A3A]';
                  const daysText = days === 0 ? '—Å–µ–≥–æ–¥–Ω—è' : days === 1 ? '–∑–∞–≤—Ç—Ä–∞' : `—á–µ—Ä–µ–∑ ${days} –¥–Ω.`;
                  return (
                    <div key={item.id} className="flex items-center gap-3">
                      <div className={`w-0.5 h-10 rounded-full shrink-0 ${barCls}`}/>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-semibold text-ink dark:text-[#DEDEDE] truncate">{item.title}</p>
                        <p className="text-xs text-faint dark:text-[#555]">{fmt.day(item.dueDate)} ¬∑ {daysText}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </Card>

          {selectedTask && <TaskModal task={selectedTask} courseName={course.name} onClose={() => setSelectedTask(null)}/>}
          {showZoom && <ZoomModal course={course} onClose={() => setShowZoom(false)}/>}
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Stats Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const Stats = ({ course, tasks }) => {
      const [activeType, setActiveType] = useState(T.HW);
      const [selectedTask, setSelectedTask] = useState(null);

      const filtered = tasks
        .filter(t => t.courseId === course.id && t.type === activeType && t.score !== null && t.score !== undefined)
        .sort((a,b) => new Date(a.date)-new Date(b.date));

      const avg   = filtered.length ? Math.round(filtered.reduce((s,t)=>s+t.score,0)/filtered.length) : 0;
      const color = T_COLOR[activeType];
      const data  = filtered.map((t,i) => ({ i:i+1, score:t.score, task:t }));

      const Tip = ({ active, payload }) => {
        if (!active || !payload?.length) return null;
        const t = payload[0].payload.task;
        return (
          <div className="bg-white dark:bg-[#1C1C1C] rounded-xl p-3 text-xs">
            <p className="font-semibold text-ink dark:text-[#DEDEDE] mb-1 max-w-[160px] leading-snug">{t.name}</p>
            <p style={{color}}>–ë–∞–ª–ª: {t.score} / {t.maxScore}</p>
            <p className="text-faint dark:text-[#555] mt-0.5">{t.date ? fmt.day(t.date) : ''}</p>
          </div>
        );
      };

      const TaskList = ({ maxH }) => (
        <div className={`${maxH ? 'overflow-y-auto no-scrollbar' : ''}`} style={maxH ? {maxHeight: maxH} : {}}>
          <div className="bg-white dark:bg-[#1C1C1C] overflow-hidden mt-2">
            <div className="px-4 pt-3 pb-1"><SectionLabel>–í—Å–µ —Ä–∞–±–æ—Ç—ã</SectionLabel></div>
            {[...filtered].reverse().map((task, idx, arr) => {
              const origIdx = arr.length-1-idx;
              const prev = origIdx > 0 ? filtered[origIdx-1] : null;
              const diff = prev ? task.score - prev.score : null;
              return (
                <div key={task.id} onClick={() => setSelectedTask(task)}
                  className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-surface dark:hover:bg-[#222] transition-colors
                    ${idx < arr.length-1 ? 'border-b border-[#F5F5F5] dark:border-[#242424]' : ''}`}>
                  <div className="flex-1 min-w-0 pr-4">
                    <p className="text-sm font-semibold text-ink dark:text-[#DEDEDE] truncate">{task.name}</p>
                    <p className="text-xs text-faint dark:text-[#555]">{task.date ? fmt.day(task.date) : ''}</p>
                  </div>
                  <div className="flex items-center gap-2 shrink-0">
                    {diff !== null && activeType === T.MOCK && (
                      <span className={`text-xs font-semibold flex items-center gap-0.5
                        ${diff>0 ? 'text-emerald-500' : diff<0 ? 'text-red-400' : 'text-faint dark:text-[#555]'}`}>
                        {diff>0 ? <IcArrowUp size={11}/> : diff<0 ? <IcArrowDown size={11}/> : <IcMinus size={11}/>}
                        {Math.abs(diff)}
                      </span>
                    )}
                    <span className="text-sm font-semibold text-ink dark:text-[#DEDEDE]">
                      {task.score}<span className="text-xs text-faint dark:text-[#555]">/{task.maxScore}</span>
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );

      const ChartPlaceholder = () => (
        <div className="py-8 text-center">
          <div className="h-28 w-full mb-4 rounded-xl bg-surface dark:bg-[#252525] flex items-end justify-around px-4 pb-3 opacity-40">
            {[40,65,50,80,55,70,45,75].map((h,i) => (
              <div key={i} className="w-5 rounded-t-md bg-[#D0D0D0] dark:bg-[#444]" style={{height:`${h}%`}}/>
            ))}
          </div>
          <p className="text-sm text-faint dark:text-[#555]">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
        </div>
      );

      const ChartBlock = ({ height = 160 }) => (
        <div style={{height}} className="w-full">
          <ResponsiveContainer width="100%" height="100%">
            {activeType === T.HW ? (
              <LineChart data={data}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(0,0,0,0.05)"/>
                <XAxis dataKey="i" axisLine={false} tickLine={false} tick={{fill:'#ADADAD',fontSize:10,fontWeight:600}}/>
                <Tooltip content={<Tip/>}/>
                <Line type="monotone" dataKey="score" stroke={color} strokeWidth={2}
                  dot={{fill:color,r:3,strokeWidth:0}} activeDot={{r:5,fill:color}}/>
              </LineChart>
            ) : (
              <BarChart data={data} barSize={28}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="rgba(0,0,0,0.05)"/>
                <XAxis dataKey="i" axisLine={false} tickLine={false} tick={{fill:'#ADADAD',fontSize:10,fontWeight:600}}/>
                <Tooltip content={<Tip/>} cursor={{fill:'transparent'}}/>
                <Bar dataKey="score" radius={[6,6,0,0]} onClick={d=>setSelectedTask(d.task)} className="cursor-pointer">
                  {data.map((_,i) => <Cell key={i} fill={color} fillOpacity={0.85}/>)}
                </Bar>
              </BarChart>
            )}
          </ResponsiveContainer>
        </div>
      );

      return (
        <div className="space-y-4">
          <div className="px-4">
            <h1 className="text-2xl font-semibold text-ink dark:text-[#DEDEDE]">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
          </div>

          <div className="px-4"><PillTabs tabs={T_ORDER.map(t => ({ value:t, label:T_LABEL[t] }))} active={activeType} onChange={setActiveType}/></div>

          <Card>
            <div className="flex items-center justify-between mb-5">
              <div>
                <SectionLabel>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</SectionLabel>
                <p className="text-xl font-semibold text-ink dark:text-[#DEDEDE] mt-1">{T_LABEL[activeType]}</p>
              </div>
              {filtered.length > 0 && (
                <div className="text-right">
                  <SectionLabel>–°—Ä–µ–¥–Ω–∏–π</SectionLabel>
                  <p className="text-2xl font-semibold text-ink dark:text-[#DEDEDE] mt-1">{avg}</p>
                </div>
              )}
            </div>
            {filtered.length === 0 ? <ChartPlaceholder/> : (
              <>
                <div className="mb-4"><ChartBlock height={144}/></div>
                <TaskList maxH={256}/>
              </>
            )}
          </Card>

          {selectedTask && <TaskModal task={selectedTask} courseName={course.name} onClose={()=>setSelectedTask(null)}/>}
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ History Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const History = ({ course, tasks }) => {
      const [selectedTask, setSelectedTask] = useState(null);
      const [typeFilter, setTypeFilter] = useState('ALL');

      const allTabs = [{ value:'ALL', label:'–í—Å–µ' }, ...T_ORDER.map(t => ({ value:t, label:T_LABEL[t] }))];
      const shown = tasks
        .filter(t => t.courseId===course.id && (typeFilter==='ALL' || t.type===typeFilter))
        .sort((a,b) => new Date(b.date)-new Date(a.date));

      return (
        <div className="space-y-4">
          <div className="px-4">
            <h1 className="text-2xl font-semibold text-ink dark:text-[#DEDEDE]">–ò—Å—Ç–æ—Ä–∏—è</h1>
          </div>

          <div className="px-4"><PillTabs tabs={allTabs} active={typeFilter} onChange={setTypeFilter}/></div>

          {shown.length === 0 ? (
            <div className="py-16 text-center text-faint dark:text-[#555] text-sm">–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</div>
          ) : (
            <div className="bg-white dark:bg-[#1C1C1C] overflow-hidden">
              {shown.map((task, idx) => (
                <div key={task.id} onClick={() => setSelectedTask(task)}
                  className={`flex items-center justify-between gap-4 px-5 py-4 cursor-pointer active:opacity-60 transition-opacity
                    ${idx < shown.length-1 ? 'border-b border-[#F5F5F5] dark:border-[#242424]' : ''}`}>
                  <div className="flex-1 min-w-0">
                    <SectionLabel>{T_LABEL[task.type]}</SectionLabel>
                    <p className="text-sm font-semibold text-ink dark:text-[#DEDEDE] truncate mt-0.5">{task.name}</p>
                    <p className="text-xs text-faint dark:text-[#555] mt-0.5">{task.date ? fmt.day(task.date) : ''}</p>
                  </div>
                  <div className="shrink-0 text-right">
                    {task.score !== null && task.score !== undefined ? (
                      <>
                        <span className="text-xl font-semibold text-ink dark:text-[#DEDEDE]">{task.score}</span>
                        <span className="text-sm text-faint dark:text-[#444]">/{task.maxScore}</span>
                      </>
                    ) : (
                      <span className="text-sm font-semibold text-emerald-500">–ó–∞—á—ë—Ç</span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {selectedTask && <TaskModal task={selectedTask} courseName={course.name} onClose={()=>setSelectedTask(null)}/>}
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Mobile Schedule Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MobileSchedulePage = ({ scheduleMap, courses, onBack }) => {
      const defaultCourse = courses.find(c => (scheduleMap[c.id] || []).length > 0) || courses[0];
      const [activeCourse, setActiveCourse] = useState(defaultCourse);
      const [monthKey, setMonthKey] = useState('');

      const events = useMemo(() => (scheduleMap[activeCourse?.id] || []).sort((a,b) => new Date(a.startsAt)-new Date(b.startsAt)), [activeCourse]);

      const byMonth = useMemo(() => {
        const map = {};
        events.forEach(e => {
          const d = new Date(e.startsAt);
          const k = `${d.getFullYear()}-${d.getMonth()}`;
          if (!map[k]) map[k] = { key:k, label: fmt.monthYear(e.startsAt), items:[] };
          map[k].items.push(e);
        });
        return Object.values(map);
      }, [events]);

      useEffect(() => {
        if (!byMonth.length) return;
        const now = new Date();
        const cur = byMonth.find(g => g.items.some(e => new Date(e.startsAt) >= now));
        setMonthKey((cur || byMonth[0])?.key || '');
      }, [byMonth]);

      const today = new Date(); today.setHours(0,0,0,0);
      const getStatus = (startsAt) => {
        const d = new Date(startsAt); d.setHours(0,0,0,0);
        const diff = Math.round((d - today) / 86400000);
        return diff < 0 ? 'past' : diff === 0 ? 'today' : 'future';
      };
      const active = byMonth.find(g => g.key === monthKey) || byMonth[0];

      return (
        <div className="flex flex-col flex-1 min-h-0 bg-surface dark:bg-[#111111]">
          <div className="px-4 pt-12 pb-4 shrink-0">
            <button onClick={onBack} className="flex items-center gap-1 text-sm font-medium text-muted dark:text-[#888] mb-3">
              <IcChevLeft size={15}/>–ù–∞–∑–∞–¥
            </button>
            <h1 className="text-2xl font-semibold text-ink dark:text-[#DEDEDE]">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
            {activeCourse && <p className="text-sm text-muted dark:text-[#888] mt-0.5 truncate">{activeCourse.name}</p>}
          </div>

          {courses.length > 1 && (
            <div className="px-4 pb-3 overflow-x-auto no-scrollbar shrink-0">
              <div className="flex gap-2 w-max">
                {courses.map(c => (
                  <button key={c.id} onClick={() => { setActiveCourse(c); setMonthKey(''); }}
                    className={`px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all max-w-[200px] truncate
                      ${c.id === activeCourse?.id
                        ? 'bg-ink text-white dark:bg-[#F0F0F0] dark:text-ink'
                        : 'bg-white dark:bg-[#1C1C1C] text-muted dark:text-[#888]'}`}>
                    {c.name}
                  </button>
                ))}
              </div>
            </div>
          )}

          <div className="px-4 pb-3 overflow-x-auto no-scrollbar shrink-0">
            <div className="flex gap-2 w-max">
              {byMonth.map(g => (
                <button key={g.key} onClick={() => setMonthKey(g.key)}
                  className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-all duration-200
                    ${g.key === monthKey
                      ? 'bg-ink text-white dark:bg-[#F0F0F0] dark:text-ink'
                      : 'bg-white dark:bg-[#1C1C1C] text-muted dark:text-[#888]'}`}>
                  {g.label}
                </button>
              ))}
            </div>
          </div>

          <div className="flex-1 overflow-y-auto no-scrollbar pb-8">
            {!active ? (
              <p className="text-sm text-faint dark:text-[#555] py-16 text-center">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</p>
            ) : (
              <div className="bg-white dark:bg-[#1C1C1C] overflow-hidden">
                {active.items.map((item, idx, arr) => {
                  const status = getStatus(item.startsAt);
                  const start  = new Date(item.startsAt);
                  const isPast  = status === 'past';
                  const isToday = status === 'today';
                  return (
                    <div key={item.id}
                      className={`grid grid-cols-[52px_1fr] gap-3 px-4 py-3.5 items-center
                        ${idx < arr.length-1 ? 'border-b border-[#F5F5F5] dark:border-[#242424]' : ''}
                        ${isToday ? 'bg-[#F5F5F5] dark:bg-[#252525]' : ''}`}>
                      <div className="text-center">
                        <p className={`text-xl font-semibold leading-none ${isPast ? 'text-faint dark:text-[#444]' : 'text-ink dark:text-[#DEDEDE]'}`}>
                          {start.getDate()}
                        </p>
                        <p className={`text-[10px] font-medium uppercase tracking-wide mt-0.5 ${isPast ? 'text-[#D0D0D0] dark:text-[#3A3A3A]' : 'text-[#8E8E93] dark:text-[#636366]'}`}>
                          {fmt.monthShort(item.startsAt)}
                        </p>
                      </div>
                      <div>
                        <p className={`text-sm font-semibold leading-snug ${isPast ? 'text-faint dark:text-[#444]' : 'text-ink dark:text-[#DEDEDE]'}`}>
                          {isToday ? '¬∑ ' : ''}{item.topic}
                        </p>
                        <p className={`text-xs mt-0.5 ${isPast ? 'text-[#D0D0D0] dark:text-[#3A3A3A]' : 'text-faint dark:text-[#555]'}`}>
                          {isPast ? '–ø—Ä–æ—à–µ–¥—à–µ–µ ¬∑ ' : isToday ? '—Å–µ–≥–æ–¥–Ω—è ¬∑ ' : ''}–∑–∞–Ω—è—Ç–∏–µ
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Deadlines Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const DeadlinesPage = ({ deadlines, courses, onBack }) => {
      const defaultCourse = courses.find(c => deadlines.some(d => d.courseId === c.id)) || courses[0];
      const [activeCourse, setActiveCourse] = useState(defaultCourse);
      const today = new Date(); today.setHours(0,0,0,0);

      const courseDls = activeCourse ? deadlines.filter(d => d.courseId === activeCourse.id) : [];

      const getDays = dueDate => {
        const d = new Date(dueDate); d.setHours(0,0,0,0);
        return Math.round((d - today) / 86400000);
      };
      const fmt24 = d => new Date(d).toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });

      const pending = courseDls.filter(d => !d.submitted).sort((a,b) => new Date(a.dueDate)-new Date(b.dueDate));
      const done    = courseDls.filter(d => d.submitted);

      const overdue  = pending.filter(d => getDays(d.dueDate) < 0);
      const urgent   = pending.filter(d => { const n = getDays(d.dueDate); return n >= 0 && n <= 1; });
      const thisWeek = pending.filter(d => { const n = getDays(d.dueDate); return n >= 2 && n <= 7; });
      const later    = pending.filter(d => getDays(d.dueDate) > 7);

      const DeadlineItem = ({ item, accent }) => {
        const days = getDays(item.dueDate);
        const course = courses.find(c => c.id === item.courseId);
        const daysLabel = days < 0 ? `–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(days)} –¥–Ω.`
          : days === 0 ? '—Å–µ–≥–æ–¥–Ω—è'
          : days === 1 ? '–∑–∞–≤—Ç—Ä–∞'
          : `—á–µ—Ä–µ–∑ ${days} –¥–Ω.`;
        return (
          <div className="flex items-start gap-3 px-5 py-4 border-b border-[#F5F5F5] dark:border-[#242424] last:border-0">
            <div className={`w-0.5 self-stretch rounded-full shrink-0 mt-1 ${accent}`}/>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-semibold text-ink dark:text-[#DEDEDE] leading-snug">{item.title}</p>
              {course && <p className="text-xs text-muted dark:text-[#888] mt-0.5">{course.name}</p>}
              <div className="flex items-center gap-2 mt-1">
                <span className="text-xs text-faint dark:text-[#555]">{fmt.day(item.dueDate)} ¬∑ {fmt24(item.dueDate)}</span>
                <span className={`text-[11px] font-semibold px-1.5 py-0.5 rounded-md ${
                  days < 0 ? 'bg-red-50 dark:bg-red-900/20 text-red-500'
                  : days <= 1 ? 'bg-[#F5F5F5] dark:bg-[#252525] text-ink dark:text-[#DEDEDE]'
                  : 'bg-[#F5F5F5] dark:bg-[#252525] text-muted dark:text-[#888]'
                }`}>{daysLabel}</span>
              </div>
            </div>
          </div>
        );
      };

      const Section = ({ label, items, accent }) => items.length === 0 ? null : (
        <div className="mb-3">
          <div className="px-5 pb-2"><SectionLabel>{label}</SectionLabel></div>
          <div className="bg-white dark:bg-[#1C1C1C] overflow-hidden">
            {items.map(item => <DeadlineItem key={item.id} item={item} accent={accent}/>)}
          </div>
        </div>
      );

      return (
        <div className="flex flex-col flex-1 min-h-0 bg-surface dark:bg-[#111111]">
          <div className="px-5 shrink-0" style={{paddingTop:'max(env(safe-area-inset-top), 44px)', paddingBottom:'16px'}}>
            <button onClick={onBack} className="flex items-center gap-1 text-sm font-medium text-muted dark:text-[#888] mb-3">
              <IcChevLeft size={15}/>–ù–∞–∑–∞–¥
            </button>
            <h1 className="text-2xl font-semibold text-ink dark:text-[#DEDEDE]">–î–µ–¥–ª–∞–π–Ω—ã</h1>
          </div>

          {courses.length > 1 && (
            <div className="px-4 pb-3 overflow-x-auto no-scrollbar shrink-0">
              <div className="flex gap-2 w-max">
                {courses.map(c => (
                  <button key={c.id} onClick={() => setActiveCourse(c)}
                    className={`px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-all max-w-[200px] truncate
                      ${c.id === activeCourse?.id
                        ? 'bg-ink text-white dark:bg-[#F0F0F0] dark:text-ink'
                        : 'bg-white dark:bg-[#1C1C1C] text-muted dark:text-[#888]'}`}>
                    {c.name}
                  </button>
                ))}
              </div>
            </div>
          )}

          <div className="flex-1 overflow-y-auto no-scrollbar pb-8">
            {overdue.length === 0 && urgent.length === 0 && thisWeek.length === 0 && later.length === 0 && done.length === 0 ? (
              <p className="text-sm text-faint dark:text-[#555] py-8 text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤</p>
            ) : (
              <>
                <Section label="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" items={overdue}  accent="bg-red-400"/>
                <Section label="–°—Ä–æ—á–Ω–æ"     items={urgent}   accent="bg-[#1A1A1A] dark:bg-[#E0E0E0]"/>
                <Section label="–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ" items={thisWeek} accent="bg-[#C0C0C0] dark:bg-[#555]"/>
                <Section label="–ü–æ–∑–∂–µ"      items={later}    accent="bg-[#D8D8D8] dark:bg-[#3A3A3A]"/>
                {done.length > 0 && (
                  <div className="mb-3 opacity-50">
                    <div className="px-5 pb-2"><SectionLabel>–°–¥–∞–Ω–æ</SectionLabel></div>
                    <div className="bg-white dark:bg-[#1C1C1C] overflow-hidden">
                      {done.map(item => <DeadlineItem key={item.id} item={item} accent="bg-[#D8D8D8] dark:bg-[#3A3A3A]"/>)}
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Mobile Bottom Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MobileNav = ({ page, setPage }) => {
      const nav = [
        { id:Page.HISTORY, Icon:IcBook  },
        { id:Page.HOME,    Icon:IcHome  },
        { id:Page.STATS,   Icon:IcChart },
      ];
      return (
        <div className="fixed bottom-0 left-0 right-0 z-50 flex justify-center pointer-events-none" style={{paddingBottom:'max(env(safe-area-inset-bottom), 16px)'}}>
          <div className="pointer-events-auto flex items-center gap-1 px-1.5 py-1.5 bg-white dark:bg-[#1C1C1C] rounded-[28px] mx-4" style={{backdropFilter:'blur(20px)', boxShadow:'0 4px 32px rgba(0,0,0,0.14)'}}>
            {nav.map(({ id, Icon }) => (
              <button key={id} onClick={() => setPage(id)}
                className={`flex items-center justify-center rounded-[20px] transition-all duration-200 p-3.5
                  ${page===id
                    ? 'bg-ink dark:bg-[#F0F0F0] text-white dark:text-ink'
                    : 'text-[#BBBBBB] dark:text-[#555]'}`}>
                <Icon size={22}/>
              </button>
            ))}
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Loading Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const LoadingScreen = () => (
      <div className="min-h-screen bg-surface flex items-center justify-center">
        <div className="text-center space-y-3">
          <div className="w-10 h-10 flex items-center justify-center mx-auto"/>
          <p className="text-sm text-faint">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );

    // ‚îÄ‚îÄ‚îÄ Email Auth Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const EmailAuthScreen = ({ onSuccess, errorMsg, setError }) => {
      const [email, setEmail] = useState('');
      const [loading, setLoading] = useState(false);

      const submit = async () => {
        const trimmed = email.trim();
        if (!trimmed) return;
        setLoading(true);
        try {
          const res = await api('/auth/email/', {
            method: 'POST',
            body: JSON.stringify({ email: trimmed }),
          });
          const data = await res.json();
          if (data.status === 'authorized') {
            await onSuccess();
          } else {
            setError(data.message || 'Email –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å.');
          }
        } catch {
          setError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
        setLoading(false);
      };

      return (
        <div className="min-h-screen bg-surface flex items-center justify-center p-4">
          <div className="w-full max-w-[360px]">
            <div className="bg-white rounded-3xl p-8 shadow-sm">
              <h1 className="text-2xl font-bold text-ink mb-2">–ö—Ä—É–∂–æ–∫ –°—Ç–∞–Ω–∫–µ–≤–∏—á–∞</h1>
              <p className="text-sm text-faint mb-6">–í–≤–µ–¥–∏—Ç–µ email, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∫–∞–∑–∞–ª–∏ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å</p>
              <input
                type="email"
                value={email}
                onChange={e => { setEmail(e.target.value); setError(''); }}
                onKeyDown={e => e.key === 'Enter' && submit()}
                placeholder="your@email.com"
                autoFocus
                className="w-full px-4 py-3 rounded-xl border border-line bg-surface text-ink text-sm outline-none focus:border-accent transition-colors mb-2"
                style={{fontFamily:'inherit'}}
              />
              {errorMsg && <p className="text-xs text-red-500 mb-3">{errorMsg}</p>}
              <button
                onClick={submit}
                disabled={loading || !email.trim()}
                className="w-full py-3 rounded-xl bg-ink text-white text-sm font-semibold disabled:opacity-40 transition-opacity mt-1"
              >
                {loading ? '–ü—Ä–æ–≤–µ—Ä—è–µ–º...' : '–í–æ–π—Ç–∏'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ‚îÄ‚îÄ‚îÄ Phrases ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const DAY_PHRASES = [
      '–†—É–±–∏–∫–æ–Ω –ø—Ä–æ–π–¥–µ–Ω',
      '–í—Ä–µ–º—è —Å–æ–±–∏—Ä–∞—Ç—å –∑–µ–º–ª–∏ üåç',
      'Veni, Vidi, Vici. üèõÔ∏è',
      '–ù–æ–≤–∞—è —ç—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å ‚ú®',
      '–í—Å—Ç–∞–≤–∞–π, –≥—Ä–∞—Ñ, —Ç–µ–±—è –∂–¥—É—Ç –≤–µ–ª–∏–∫–∏–µ –¥–µ–ª–∞!',
      'Sapere Aude üìú',
      '–ò—Å—Ç–æ—Ä–∏—è ‚Äî —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –∂–∏–∑–Ω–∏',
      'Ad fontes!',
      '–†–∞–∑–¥–µ–ª—è–π –∏ –≤–ª–∞—Å—Ç–≤—É–π',
      '–ö—Ä–∏—Ç–∏–∫—É–π –∏—Å—Ç–æ—á–Ω–∏–∫, –∞ –Ω–µ –∞–≤—Ç–æ—Ä–∞',
      '–ò—Å—Ç–∏–Ω–∞ –≥–¥–µ-—Ç–æ –≤ –∞—Ä—Ö–∏–≤–∞—Ö',
      'Finis coronat opus üëë',
      '–ö–∞—Ä—Ñ–∞–≥–µ–Ω —Ä–∞–∑—Ä—É—à–µ–Ω ‚öîÔ∏è',
      'Sic transit gloria mundi',
      '–ú–∏—Ä –≤–∞—à–µ–º—É –¥–æ–º—É',
      '–ü–æ—Å–ª–µ –Ω–∞—Å —Ö–æ—Ç—å –ø–æ—Ç–æ–ø üåä',
      '–≠–ø–æ—Ö–∞ –≤–µ–ª–∏–∫–∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π',
      '–í–µ–∫ –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è üïØÔ∏è',
      '–†–∞—Å—Å–≤–µ—Ç –∏–º–ø–µ—Ä–∏–∏.',
      '–í—Ä–µ–º—è —Ä–µ—Ñ–æ—Ä–º.',
    ];
    const NIGHT_PHRASES = [
      '–ê—Ä—Ö–∏–≤—ã –Ω–µ —Å–ø—è—Ç (–∏ —Ç—ã –Ω–µ —Å–ø–∏—à—å ü¶â)',
      'Ad astra per aspera üåô',
      '–ò—Å—Ç–æ—Ä–∏—è –ø–∏—à–µ—Ç—Å—è –Ω–æ—á—å—é',
      '–¢–µ–Ω—å –≤–µ–∫–æ–≤ —É–¥–ª–∏–Ω—è–µ—Ç—Å—è',
    ];
    const pickPhrase = () => {
      const h = new Date().getHours();
      const isNight = h >= 20;
      const pool = isNight ? [...DAY_PHRASES, ...NIGHT_PHRASES] : [...DAY_PHRASES];
      const key = 'kruzhok_phrase_queue';
      let queue = [];
      try { queue = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) {}
      // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–∑—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—É–ª–∞ (–Ω–æ—á–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –¥–Ω—ë–º)
      queue = queue.filter(p => pool.includes(p));
      if (queue.length === 0) {
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–µ—Å—å –ø—É–ª (Fisher-Yates)
        const arr = [...pool];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        queue = arr;
      }
      const phrase = queue.shift();
      try { localStorage.setItem(key, JSON.stringify(queue)); } catch(e) {}
      return phrase;
    };

    // ‚îÄ‚îÄ‚îÄ App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const App = () => {
      // ‚îÄ‚îÄ –í—Å–µ —Ö—É–∫–∏ –æ–±—ä—è–≤–ª—è–µ–º –¥–æ –ª—é–±—ã—Ö —Ä–∞–Ω–Ω–∏—Ö return (–ø—Ä–∞–≤–∏–ª–æ React) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const [authState,   setAuthState]   = useState('loading'); // loading | need_email | authorized
      const [authError,   setAuthError]   = useState('');
      const [appData,     setAppData]     = useState(null);
      const [page,        setPage]        = useState(Page.HOME);
      const [course,      setCourse]      = useState(null);
      const [isDark,      setIsDark]      = useState(false);
      const [studentName, setStudentName] = useState('');
      const [editingName, setEditingName] = useState(false);
      const [nameInput,   setNameInput]   = useState('');
      const [showLogout,  setShowLogout]  = useState(false);
      const [phrase] = useState(pickPhrase);

      useEffect(() => { initAuth(); }, []);

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º sub-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –∫—É—Ä—Å–∞
      useEffect(() => {
        if (course && (page === Page.SCHEDULE || page === Page.DEADLINES)) {
          setPage(Page.HOME);
        }
      }, [course?.id]);

      // ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const loadData = async () => {
        try {
          const [meRes, coursesRes, gradesRes, scheduleRes, deadlinesRes] = await Promise.all([
            api('/api/me/'),
            api('/api/courses/'),
            api('/api/grades/'),
            api('/api/schedule/'),
            api('/api/deadlines/'),
          ]);

          if (!meRes.ok) {
            setAuthState('need_email');
            return;
          }

          const me                  = await meRes.json();
          const { courses }         = await coursesRes.json();
          const { grades }          = await gradesRes.json();
          const { schedule }        = await scheduleRes.json();
          const { deadlines: dlRaw} = await deadlinesRes.json();

          // Grades ‚Üí —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          const tasks = grades.map(g => ({
            id:             g.id,
            courseId:       g.course_id,
            type:           g.type,        // —É–∂–µ 'HW'/'MOCK'/'ESSAY'/'PROJECT'
            name:           g.name,
            date:           g.date || '',
            score:          g.score,
            maxScore:       g.max_score,
          }));

          // Schedule ‚Üí –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ course_id –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
          const scheduleMap = {};
          schedule.forEach(e => {
            if (!scheduleMap[e.course_id]) scheduleMap[e.course_id] = [];
            scheduleMap[e.course_id].push({
              id:          e.id,
              topic:       e.topic,
              startsAt:    e.starts_at,
              durationMin: e.duration_minutes,
            });
          });

          // Deadlines ‚Üí camelCase
          const deadlines = dlRaw.map(d => ({
            id:        d.id,
            courseId:  d.course_id,
            title:     d.title,
            dueDate:   d.due_date,
            submitted: d.submitted,
          }));

          setAppData({ me, courses, tasks, scheduleMap, deadlines });
          setStudentName(me.name);
          setNameInput(me.name);
          if (courses.length > 0) {
            const now = new Date();
            const withUpcoming = courses.find(c =>
              (scheduleMap[c.id] || []).some(e => new Date(e.startsAt) > now)
            );
            setCourse(withUpcoming || courses[0]);
          }
          setAuthState('authorized');
        } catch {
          setAuthState('need_email');
        }
      };

      // ‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const initAuth = async () => {
        // 1. Telegram Mini App ‚Äî initData
        if (window.Telegram?.WebApp?.initData) {
          try {
            const res  = await api('/auth/telegram/', {
              method: 'POST',
              body:   JSON.stringify({ init_data: window.Telegram.WebApp.initData }),
            });
            const json = await res.json();
            if (json.status === 'authorized') { await loadData(); return; }
            if (json.status === 'need_link')  { setAuthState('need_email'); return; }
          } catch {}
        }

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
        try {
          const meRes = await api('/api/me/');
          if (meRes.ok) { await loadData(); return; }
        } catch {}

        // 3. –ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ email
        setAuthState('need_email');
      };

      // ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const saveName = async (newName) => {
        const name = newName.trim() || studentName;
        setStudentName(name);
        setEditingName(false);
        try {
          await api('/api/update-name/', {
            method: 'POST',
            body:   JSON.stringify({ name }),
          });
        } catch {}
      };

      // ‚îÄ‚îÄ Auth screens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if (authState === 'loading')    return <LoadingScreen/>;
      if (authState === 'need_email') return (
        <EmailAuthScreen
          onSuccess={loadData}
          errorMsg={authError}
          setError={setAuthError}
        />
      );
      if (!appData || !course)        return <LoadingScreen/>;

      // ‚îÄ‚îÄ –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const events = (appData.scheduleMap[course.id] || []).sort((a,b) => new Date(a.startsAt)-new Date(b.startsAt));

      return (
        <div className={isDark ? 'dark' : ''}>
          <div className="min-h-[100dvh] bg-surface dark:bg-[#111111] text-ink dark:text-[#DEDEDE] transition-colors duration-200">

            <div className="flex justify-center min-h-[100dvh] bg-surface dark:bg-[#111111]">
              <div className="w-full max-w-[390px] min-h-[100dvh] bg-surface dark:bg-[#111111] relative flex flex-col">

                {page === Page.SCHEDULE ? (
                  <MobileSchedulePage scheduleMap={appData.scheduleMap} courses={appData.courses} onBack={() => setPage(Page.HOME)}/>
                ) : page === Page.DEADLINES ? (
                  <DeadlinesPage deadlines={appData.deadlines} courses={appData.courses} onBack={() => setPage(Page.HOME)}/>
                ) : (
                  <>
                    {/* ‚îÄ‚îÄ –®–∞–ø–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
                    {page === Page.HOME ? (
                      <div className="shrink-0 px-5" style={{paddingTop:'max(env(safe-area-inset-top), 44px)', paddingBottom:'16px'}}>
                        {/* –¶–∏—Ç–∞—Ç–∞ + —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */}
                        <div className="flex items-center justify-between mb-3">
                          <span className="text-[16px] text-muted dark:text-[#666] italic leading-snug flex-1 pr-3">{phrase}</span>
                          <button onClick={() => setIsDark(!isDark)}
                            className="w-8 h-8 rounded-full bg-white dark:bg-[#252525] flex items-center justify-center text-muted dark:text-[#888] shrink-0">
                            {isDark ? <IcSun size={16}/> : <IcMoon size={16}/>}
                          </button>
                        </div>
                        {/* –ò–º—è + email */}
                        <div className="mb-3">
                          {editingName ? (
                            <input autoFocus value={nameInput}
                              onChange={e => setNameInput(e.target.value)}
                              onBlur={() => saveName(nameInput)}
                              onKeyDown={e => {
                                if (e.key === 'Enter')  saveName(nameInput);
                                if (e.key === 'Escape') { setNameInput(studentName); setEditingName(false); }
                              }}
                              className="text-[26px] font-bold text-ink dark:text-[#DEDEDE] bg-transparent outline-none w-full leading-tight block"
                              style={{caretColor:'#007AFF', border:'none', padding:0, fontFamily:'inherit'}}
                            />
                          ) : (
                            <button onClick={() => { setNameInput(studentName); setEditingName(true); }}
                              className="flex items-center gap-2 text-left w-full">
                              <h1 className="text-[26px] font-bold text-ink dark:text-[#DEDEDE] leading-tight">{studentName}</h1>
                              <IcPencil size={14} className="text-[#CCCCCC] dark:text-[#555] shrink-0 mt-0.5"/>
                            </button>
                          )}
                          <div className="relative mt-1">
                            <button onClick={() => setShowLogout(v => !v)}
                              className="text-sm text-faint dark:text-[#555] hover:opacity-70 transition-opacity">
                              {appData.me.email}
                            </button>
                            {showLogout && (
                              <>
                                <div className="fixed inset-0 z-[9]" onClick={() => setShowLogout(false)}/>
                                <div className="absolute left-0 top-full mt-1.5 z-10 bg-white dark:bg-[#2A2A2A] rounded-2xl overflow-hidden"
                                  style={{boxShadow:'0 4px 24px rgba(0,0,0,0.12)'}}>
                                  <button onClick={() => { window.location.href = '/auth/logout/'; }}
                                    className="block px-4 py-3 text-sm text-red-400 hover:bg-surface dark:hover:bg-[#333] transition-colors whitespace-nowrap w-full text-left">
                                    –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                                  </button>
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                        {/* –ö—É—Ä—Å—ã */}
                        <div className="flex gap-2 overflow-x-auto no-scrollbar -mx-5 px-5">
                          {appData.courses.map(c => (
                            <button key={c.id} onClick={() => setCourse(c)}
                              className={`shrink-0 px-3 py-1.5 rounded-full text-xs font-semibold transition-all max-w-[200px] truncate
                                ${c.id === course.id
                                  ? 'bg-ink text-white dark:bg-[#F0F0F0] dark:text-ink'
                                  : 'bg-white dark:bg-[#252525] text-muted dark:text-[#888]'}`}>
                              {c.name}
                            </button>
                          ))}
                          <div className="shrink-0 w-5"/>
                        </div>
                      </div>
                    ) : (
                      /* ‚îÄ‚îÄ –ú–∏–Ω–∏-–±–∞—Ä –¥–ª—è Stats/History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
                      <div className="px-5 flex items-center justify-between shrink-0"
                        style={{paddingTop:'max(env(safe-area-inset-top), 44px)', paddingBottom:'8px'}}>
                        <span className="text-[16px] text-muted dark:text-[#666] italic">{phrase}</span>
                        <button onClick={() => setIsDark(!isDark)}
                          className="w-8 h-8 rounded-full bg-white dark:bg-[#252525] flex items-center justify-center text-muted dark:text-[#888]">
                          {isDark ? <IcSun size={16}/> : <IcMoon size={16}/>}
                        </button>
                      </div>
                    )}

                    {/* ‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–Ω—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */}
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-32 pt-4">
                      {page === Page.HOME    && <Home    course={course} tasks={appData.tasks} events={events} deadlines={appData.deadlines} streak={appData.me.streak || 0} onSchedule={() => setPage(Page.SCHEDULE)} onDeadlines={() => setPage(Page.DEADLINES)}/>}
                      {page === Page.STATS   && <Stats   course={course} tasks={appData.tasks}/>}
                      {page === Page.HISTORY && <History course={course} tasks={appData.tasks}/>}
                    </div>

                    <MobileNav page={page} setPage={setPage}/>
                  </>
                )}
              </div>
            </div>

          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
