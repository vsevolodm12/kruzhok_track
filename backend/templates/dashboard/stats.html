{% extends "base.html" %}

{% block title %}Статистика — Кружок{% endblock %}

{% block extra_head %}
<!-- Chart.js для графиков -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full" x-data="{ activeTab: '{{ active_tab }}' }">

  <!-- Заголовок -->
  <div class="mb-6 px-1">
    <h1 class="text-3xl font-semibold text-brand-dark dark:text-white mb-1">Статистика</h1>
    <p class="text-brand-subtext dark:text-slate-500 text-sm">Анализ по категориям</p>
  </div>

  <!-- Табы -->
  <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-6 py-2">
    {% for type in task_types %}
    <a
      href="?type={{ type.key }}"
      class="whitespace-nowrap px-5 py-2.5 rounded-full text-xs font-semibold tracking-wide transition-all duration-300
        {% if active_tab == type.key %}
          text-white shadow-md transform scale-105
          {% if type.key == 'homework' %}bg-emerald-500{% elif type.key == 'mock' %}bg-sky-500{% elif type.key == 'essay' %}bg-amber-500{% else %}bg-violet-500{% endif %}
        {% else %}
          bg-white/80 dark:bg-slate-800/80 text-gray-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-700
        {% endif %}"
    >
      {{ type.label|upper }}
    </a>
    {% endfor %}
  </div>

  <!-- Карточка статистики -->
  <div class="glass-card flex-grow p-6 flex flex-col">
    <div class="flex items-center justify-between mb-6">
      <div>
        <p class="text-xs font-semibold text-gray-400 dark:text-slate-500 uppercase tracking-wider">Категория</p>
        <h2 class="text-xl font-semibold text-brand-dark dark:text-white">
          {% for type in task_types %}{% if type.key == active_tab %}{{ type.label }}{% endif %}{% endfor %}
        </h2>
      </div>

      {% if grades %}
      <div class="text-right">
        <p class="text-xs font-semibold text-gray-400 dark:text-slate-500 uppercase tracking-wider">Средний</p>
        <p class="text-2xl font-semibold text-brand-dark dark:text-white">{{ average_score }}</p>
      </div>
      {% endif %}
    </div>

    {% if not grades %}
    <div class="flex-grow flex flex-col items-center justify-center text-center opacity-50">
      <p class="font-semibold text-brand-subtext dark:text-slate-400">Недостаточно данных</p>
      <p class="text-xs text-gray-400 dark:text-slate-500 mt-1">Нужно минимум 1 работа</p>
    </div>
    {% else %}

    <!-- График -->
    <div class="h-40 w-full mb-4">
      <canvas id="statsChart"></canvas>
    </div>

    <!-- Список работ -->
    <div class="space-y-2 overflow-y-auto no-scrollbar flex-grow">
      <h3 class="text-xs font-semibold text-gray-400 dark:text-slate-500 uppercase mb-2">
        {% if active_tab == 'mock' %}Результаты{% else %}Все работы{% endif %}
      </h3>

      {% for item in chart_data %}
      <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-700/30 rounded-xl border border-white/50 dark:border-slate-600/30">
        <div class="flex flex-col min-w-0 flex-1">
          <span class="text-xs font-medium text-gray-400 dark:text-slate-500">{{ item.grade.checked_at|date:"d.m.Y" }}</span>
          <span class="text-sm font-semibold text-brand-dark dark:text-white truncate">{{ item.grade.task.name }}</span>
        </div>

        <div class="flex items-center space-x-3">
          {% if item.diff is not None %}
          <div class="flex items-center px-2 py-1 rounded-lg text-xs font-semibold
            {% if item.diff > 0 %}bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400{% elif item.diff < 0 %}bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400{% else %}bg-gray-50 dark:bg-slate-600/50 text-gray-400 dark:text-slate-400{% endif %}">
            {% if item.diff > 0 %}
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5 12 7-7 7 7M12 19V5"></path>
            </svg>
            {% elif item.diff < 0 %}
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m7-7-7 7-7-7"></path>
            </svg>
            {% else %}
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"></path>
            </svg>
            {% endif %}
            {% if item.diff >= 0 %}{{ item.diff }}{% else %}{{ item.diff|slice:"1:" }}{% endif %}
          </div>
          {% endif %}

          <div class="flex items-baseline">
            <span class="text-lg font-semibold text-brand-dark dark:text-white">{{ item.grade.value }}</span>
            <span class="text-xs text-gray-400 dark:text-slate-500 ml-1">/{{ item.grade.task.max_score }}</span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
{% if grades %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('statsChart').getContext('2d');
  const chartData = [{% for item in chart_data %}{{ item.grade.value }}{% if not forloop.last %}, {% endif %}{% endfor %}];
  const chartLabels = [{% for item in chart_data %}'{{ item.index }}'{% if not forloop.last %}, {% endif %}{% endfor %}];

  const activeTab = '{{ active_tab }}';
  const colors = {
    'homework': '#10b981',
    'mock': '#0ea5e9',
    'essay': '#f59e0b',
    'project': '#8b5cf6'
  };
  const color = colors[activeTab] || '#0ea5e9';

  const chartType = (activeTab === 'homework') ? 'line' : 'bar';

  new Chart(ctx, {
    type: chartType,
    data: {
      labels: chartLabels,
      datasets: [{
        data: chartData,
        borderColor: color,
        backgroundColor: chartType === 'line' ? 'transparent' : color + 'cc',
        borderWidth: chartType === 'line' ? 2.5 : 0,
        tension: 0.3,
        pointBackgroundColor: color,
        pointRadius: 3,
        borderRadius: chartType === 'bar' ? 8 : 0,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(255,255,255,0.95)',
          titleColor: '#0f172a',
          bodyColor: '#0f172a',
          borderColor: 'rgba(255,255,255,0.8)',
          borderWidth: 1,
          cornerRadius: 12,
          padding: 12,
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#94a3b8', font: { size: 10, weight: 600 } }
        },
        y: {
          grid: { color: 'rgba(148, 163, 184, 0.1)' },
          ticks: { display: false }
        }
      }
    }
  });
});
</script>
{% endif %}
{% endblock %}

{% block nav %}
{% with active='stats' %}
{% include "components/nav.html" %}
{% endwith %}
{% endblock %}
