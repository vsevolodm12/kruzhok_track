# Telegram Mini App для Stankevich Academy

## Обзор системы

Приложение представляет собой интерфейс внутри Telegram, где ученики видят свой прогресс по курсам: оценки, комментарии преподавателей, статистику выполнения заданий.

Ключевая особенность — **полная автоматизация**. Преподаватели продолжают работать в ZenClass как обычно: проверяют задания, пишут комментарии с оценками. Система автоматически забирает эти данные и показывает ученикам в удобном формате.

---

## Интеграция с ZenClass

### Как ZenClass передаёт данные

ZenClass имеет встроенную систему **Автоматизации** — это механизм, который позволяет отправлять данные о событиях на внешние сервисы. Мы используем именно его.

### Настройка в ZenClass (делается один раз)

1. Заходим в ZenClass → раздел **«Автоматизация»**
2. Создаём новый процесс
3. Выбираем **триггер** (событие, которое запускает отправку):
   - «Задание принято» — когда преподаватель проверил работу
   - «Студент подписался на продукт» — когда ученик купил курс
   - «Закончился доступ к курсу» — когда истёк срок
4. Выбираем действие **«Отправить HTTP-уведомление»**
5. Вставляем URL нашего сервера (например: `https://api.stankevich-app.ru/webhook`)
6. Сохраняем и запускаем процесс

После этого ZenClass будет автоматически отправлять данные при каждом событии.

### Что именно отправляет ZenClass

Когда преподаватель принимает задание, ZenClass формирует пакет данных и отправляет его на наш сервер. Вот как выглядит этот пакет (упрощённо):

```json
{
  "event_name": "lesson_task_accepted",
  "timestamp": 1770023268,
  "payload": {
    "user_email": "student@mail.ru",
    "course_name": "Интенсив по экономике",
    "task_name": "Домашнее задание №3",
    "comment": "4"
  }
}
```

Разберём ключевые поля:

| Поле | Что означает | Как используем |
|------|--------------|----------------|
| `event_name` | Тип события | Понимаем, что произошло |
| `timestamp` | Время события (Unix) | Считаем streak |
| `user_email` | Email ученика | Находим его в базе |
| `course_name` | Название курса | Показываем в интерфейсе |
| `task_name` | Название задания | Показываем в интерфейсе |
| `comment` | Комментарий преподавателя | **Извлекаем оценку** |

### Безопасность: как мы проверяем, что данные настоящие

Каждый пакет от ZenClass содержит цифровую подпись (`hash`). Наш сервер проверяет её по алгоритму:

1. Берём секретный ключ (выдаётся в настройках автоматизации)
2. Комбинируем его с ID запроса и временем
3. Вычисляем контрольную сумму
4. Сравниваем с тем, что прислал ZenClass

Если подпись не совпадает — данные игнорируются. Это защита от поддельных запросов.

---

## Полный цикл: от проверки до уведомления

### Шаг 1: Преподаватель проверяет задание

Преподаватель заходит в ZenClass, открывает работу ученика, проверяет её и пишет комментарий:

```
Хорошая работа! Оценка: 4
```

Нажимает «Принять».

### Шаг 2: ZenClass отправляет webhook

В тот же момент ZenClass формирует пакет данных:

```json
{
  "user_email": "ivanov@mail.ru",
  "course_name": "Интенсив по экономике", 
  "task_name": "ДЗ от 26.01",
  "comment": "Хорошая работа! Оценка: 4",
  "timestamp": 1770023268
}
```

И отправляет его POST-запросом на наш сервер.

### Шаг 3: Сервер обрабатывает данные

Наш сервер получает пакет и выполняет:

1. **Проверка подписи** — убеждаемся, что данные от ZenClass
2. **Поиск ученика** — ищем в базе по `user_email`
3. **Парсинг оценки** — из строки `"Хорошая работа! Оценка: 4"` извлекаем число `4`
4. **Сохранение** — записываем оценку и комментарий в базу данных
5. **Расчёт streak** — проверяем, сколько дней подряд ученик сдаёт работы
6. **Уведомление** — отправляем сообщение в Telegram

### Шаг 4: Ученик получает уведомление

В Telegram приходит сообщение:

> Твоя работа по курсу «Интенсив по экономике» проверена. Оценка: 4

### Шаг 5: Ученик смотрит детали в Mini App

Открыв приложение, ученик видит:
- Все свои курсы с прогрессом
- Оценки по каждому заданию
- Полный комментарий преподавателя
- Свой streak

---

## Какие события мы отслеживаем

В ZenClass настраиваем несколько процессов автоматизации:

| Событие в ZenClass | Что получаем | Что делаем |
|--------------------|--------------|------------|
| **Задание принято** | Email, курс, задание, комментарий, время | Сохраняем оценку, считаем streak, шлём уведомление |
| **Подписка на продукт** | Email, название курса | Добавляем ученика на курс |
| **Доступ истёк** | Email, курс | Помечаем курс как завершённый |

---

## Откуда берём начальные данные

### Проблема

ZenClass не позволяет получить список всех учеников через API. Вебхуки работают только для **новых** событий — они не отдают историю.

### Решение

ZenClass умеет выгружать данные в Google Sheets автоматически. Там есть:
- Список всех учеников с email
- Какие курсы купил каждый ученик
- История по каждому курсу

При запуске системы мы **один раз** импортируем эти данные в нашу базу. После этого Google Sheets больше не нужен — все новые данные приходят через вебхуки.

---

## Процесс авторизации ученика

### Первый вход

1. Ученик открывает Mini App в Telegram
2. Telegram передаёт нам данные пользователя (ID, имя)
3. Мы проверяем — есть ли этот Telegram ID в нашей базе
4. Если нет — просим ввести email
5. Ученик вводит email, который использовал при покупке
6. Находим его в базе, связываем с Telegram ID

### Последующие входы

Связка сохранена. Ученик сразу видит свои данные без повторной авторизации.

---

## Что видит ученик в Mini App

### Главный экран

- Список курсов с прогрессом (сдано X из Y заданий)
- Текущий streak (дни подряд с выполненными заданиями)
- Последние оценки

### Экран курса

- Список всех заданий
- Статус каждого: на проверке / принято / не сдано
- Оценка и комментарий преподавателя

### Уведомления

- Приходят в Telegram при каждой проверке
- Содержат название курса и оценку

---

## Техническая надёжность

### Повторные попытки

Если наш сервер не ответил (был недоступен), ZenClass повторит отправку:
- Через 5 минут
- Через 30 минут
- Через 1 час
- Через 3 часа
- Через 6 часов

Всего 5 попыток. Данные не потеряются при кратковременных сбоях.

### Защита от дублей

Каждый webhook имеет уникальный ID. Если ZenClass отправит один и тот же пакет дважды (например, при повторной попытке), мы обработаем его только один раз.

### Независимость от ZenClass

Все данные хранятся в нашей базе. Если ZenClass временно недоступен — Mini App продолжает работать с уже загруженными данными.



## Что входит в разработку

1. **Telegram Mini App** — интерфейс для учеников
2. **Серверная часть** — приём вебхуков, хранение данных, парсинг оценок
3. **Telegram-бот** — отправка уведомлений
4. **Миграция данных** — импорт из Google Sheets
5. **Настройка сервера** — VPS, домен, SSL
6. **Настройка ZenClass** — создание процессов автоматизации
7. **Документация** — инструкции по использованию
