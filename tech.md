### 0. TODO: Дополнительные фичи

> **Расписание курса:** Расписание уроков будет загружаться в отдельную таблицу перед каждым курсом (Google Sheets → Schedule table). Структура: дата занятия + название.

> **Дедлайны:** Пока не определено — либо через webhook передавать, либо вручную добавлять в таблицу с расписанием курса. ZenClass webhooks не передают данные о дедлайнах напрямую.

---

### 1. Stack (Modern Monolith)

* **Backend:** Django (Python) — ядро системы, ORM, админ-панель.
* **Database:** PostgreSQL — надежное хранилище данных, транзакционность.
* **Frontend (Interactivity):** htmx — обновление UI без перезагрузок (SPA-behavior).
* **Frontend (Micro-logic):** Alpine.js — управление состояниями на клиенте (модалки, табы).
* **UI/Styles:** Tailwind CSS — быстрая верстка адаптивного TMA.
* **Infrastructure:** Docker + Nginx — контейнеризация и деплой.
* **Integration:** Telegram Bot API (aiogram или аналоги для уведомлений).

### 2. General Logic & Data Flow

Система работает как **Центральный Узел (Hub)**, который агрегирует данные из внешних источников и отдает их в интерфейс TMA.

1. **Событийная модель:** Бэкенд слушает вебхуки ZenClass. При получении события данные проходят через слой валидации и маппинга, сохраняясь в Postgres.


2. **Интерфейс:** TMA запрашивает данные только из Postgres, что обеспечивает мгновенный отклик (UX), не зависящий от скорости работы Google Sheets или ZenClass.

### 3. Авторизация и Безопасность

**Механика входа:**

* При запуске TMA мы получаем `initData` от Telegram.
* **Проверка подлинности:** Бэкенд проверяет подпись `hash` из `initData`, используя токен бота. Это гарантирует, что запрос пришел от реального пользователя Telegram.
* **JWT vs Session:** В данном стеке **JWT не нужен**. Мы используем стандартную систему сессий Django. Это проще, безопаснее (HttpOnly cookies) и лучше подходит для монолита.

**Связка аккаунтов:**

* Если `telegram_id` пользователя не найден в БД, просим ввести **Email**.
* Бэкенд проверяет наличие этого Email в таблице «Ученики» (загруженной из Google Sheets/ZenClass).
* Если совпадение найдено — связываем `telegram_id` с профилем ученика.

### 4. Mark Parsing (Логика обработки оценок)

Поскольку ZenClass не отдает оценку отдельным полем, используется логика **Semantic Extraction**:

* **Триггер:** Вебхук `lesson_task_accepted`.
* **Источник:** Поле `payload.comment`.
* **Алгоритм парсинга:**
1. Регулярное выражение ищет первую цифру или паттерн (например, "Оценка: 5", "5/5").
2. Если цифра найдена, она записывается в поле `Grade.value`.
3. Весь текст комментария сохраняется в `Grade.teacher_comment`.
4. Если цифр нет, статус задания просто меняется на «Принято» (зачет).

**Структура вебхука `lesson_task_accepted` (проверено):**

```json
{
  "id": "6TuhRlq4YVu9WS7DTQur4FrTq4RJPCBY",
  "hash": "21da7ce48e6dc084ceec027ae8c77f6b4b0273a0",
  "event_name": "lesson_task_accepted",
  "timestamp": 1770023268,
  "payload": {
    "user_id": "c4f1316c-a705-4f0b-99ca-6c22682e8114",
    "user_email": "student@example.com",
    "course_id": "3a2bdb1f-6834-4b3b-8190-2798fe750663",
    "course_name": "Название курса",
    "tariff_id": "4cc3c960-0b75-49b2-bbbd-e27fcbb0869d",
    "tariff_name": "Единый тариф",
    "task_id": "4e628d84-0cb1-4717-b8d6-a868459c56c1",
    "task_name": "26.01 23:59",
    "task_type": "Assignment",
    "task_result": "ok",
    "report_link": "https://school.zenclass.ru/desktop/dashboard/report/...",
    "comment": "4"
  }
}
```

**Маппинг полей:**

| Поле webhook | Поле в БД | Описание |
|--------------|-----------|----------|
| `payload.user_email` | `Student.email` | Идентификация ученика |
| `payload.user_id` | `Student.zenclass_id` | UUID в ZenClass |
| `payload.course_id` | `Course.zenclass_id` | UUID курса |
| `payload.course_name` | `Course.name` | Название для UI |
| `payload.task_id` | `Task.zenclass_id` | UUID задания |
| `payload.task_name` | `Task.name` | Название задания |
| `payload.comment` | `Grade.teacher_comment` | Источник для парсинга оценки |
| `payload.task_result` | `Grade.status` | "ok" = принято |
| `timestamp` | `Grade.checked_at` | Дата проверки (для стриков) |
| `hash` | — | Верификация подписи |


### 5. Архитектура данных и жизненный цикл доступов

Система функционирует на базе локального «зеркала» данных в PostgreSQL, что исключает задержки при обращении к внешним сервисам.

**Первичное наполнение (миграция):**

ZenClass API не предоставляет методов для получения списков учеников. Поэтому историческая миграция реализуется через одноразовый импорт из Google Sheets:
* Таблица «Студенты» — содержит email, имя, список купленных курсов (колонка «Покупки»).
* Таблица «Курсы» — отдельный лист на каждый курс со списком учеников.

Импорт выполняется один раз при запуске системы. После этого Google Sheets больше не используются.

**Поддержание актуальности (webhooks):**

После миграции все изменения поступают через вебхуки ZenClass:

| Событие | `event_name` | Ключевые поля payload | Действие в системе |
|---------|--------------|----------------------|-------------------|
| Подписка на курс | `product_user_subscribed` | `user_email`, `product_id`, `product_name` | Создание связи Student ↔ Course |
| Оплата | `payment_accepted` | `user_email`, `product_id`, `payment_amount` | Подтверждение доступа |
| Задание принято | `lesson_task_accepted` | `user_email`, `course_id`, `task_id`, `comment`, `timestamp` | Парсинг оценки, расчёт streak |
| Доступ истёк | `access_to_course_expired` | `user_email`, `course_id` | Пометка курса как завершённого |

**Идемпотентность:** Каждый вебхук содержит уникальный `id`. При повторной доставке (retry) система проверяет, был ли этот `id` уже обработан, и игнорирует дубликаты.

**Верификация:** Подпись вычисляется как `sha1(secret_key & id & timestamp)` и сравнивается с полем `hash`.

### 6. Business Logic (Features)

* 
**Прогресс и Стрики:** Каждый webhook содержит поле `timestamp` (Unix time) — дата события. На основе timestamp из `lesson_task_accepted` рассчитывается streak: количество последовательных дней с принятыми заданиями.


* **Уведомления:** При каждом успешном парсинге оценки бэкенд отправляет сообщение в Telegram-бот: «Твоя работа по курсу [X] проверена. Оценка: [Y]».


* 
**Dashboard Ученика:** Список всех курсов, фильтрация по статусу (проверено/на проверке), детальный просмотр комментариев учителя.



### 7. Принципы разработки (Best Practices)

* **Security:**
* Проверка хэша вебхуков ZenClass (алгоритм `sha1`).
* Хранение секретных ключей (Google API, ZenClass Secret, Bot Token) строго в `.env`.


* **OOP & Models:**
* `Student`, `Course`, `Lesson`, `Grade` — четкие сущности с методами валидации внутри.


* **DRY (Don't Repeat Yourself):**
* Единый сервис-слой для работы с Telegram API и Google Sheets API.


* **Mapping:**
* Использование промежуточных DTO (Data Transfer Objects) для преобразования JSON из вебхуков в объекты Django-моделей.

